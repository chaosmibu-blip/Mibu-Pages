æ–°å¢ï¼šé€€æ¬¾èˆ‡å–æ¶ˆè¨‚é–±åŠŸèƒ½
å•†å®¶ç™»å…¥å¾Œçš„è¨‚é–±ç®¡ç†é é¢éœ€æ–°å¢ä»¥ä¸‹åŠŸèƒ½ï¼š

1. é€€æ¬¾è³‡æ ¼æª¢æŸ¥ API
// hooks/useRefundEligibility.ts
import { useQuery } from '@tanstack/react-query';
interface RefundEligibility {
  subscriptionId: number;
  provider: 'stripe' | 'recur';
  tier: string;
  status: string;
  createdAt: string;
  daysSinceCreation: number;
  refundEligibility: {
    isEligible: boolean;
    reason: string;
    hoursRemaining: number;
    daysRemaining: number;
  };
  cancellationPolicy: {
    canCancel: boolean;
    note: string;
  };
}
export function useRefundEligibility(subscriptionId: number) {
  return useQuery<RefundEligibility>({
    queryKey: ['refund-eligibility', subscriptionId],
    queryFn: async () => {
      const res = await fetch(
        `${process.env.NEXT_PUBLIC_API_URL}/api/merchant/subscription/refund-eligibility?subscriptionId=${subscriptionId}`,
        { credentials: 'include' }
      );
      if (!res.ok) throw new Error('Failed to check eligibility');
      return res.json();
    },
    enabled: !!subscriptionId,
  });
}
2. ç”³è«‹é€€æ¬¾ API
// hooks/useRefundRequest.ts
import { useMutation, useQueryClient } from '@tanstack/react-query';
interface RefundRequestInput {
  subscriptionId: number;
  reason: string; // è‡³å°‘ 10 å­—
}
interface RefundResponse {
  success: boolean;
  message: string;
  refundStatus: 'approved' | 'pending_manual_review' | 'not_eligible' | 'error';
  refundId?: string;
  requestId?: number;
  eligibility: any;
  contactEmail?: string;
}
export function useRefundRequest() {
  const queryClient = useQueryClient();
  
  return useMutation<RefundResponse, Error, RefundRequestInput>({
    mutationFn: async (data) => {
      const res = await fetch(
        `${process.env.NEXT_PUBLIC_API_URL}/api/merchant/subscription/refund-request`,
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(data),
        }
      );
      return res.json();
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['subscriptions'] });
      queryClient.invalidateQueries({ queryKey: ['refund-eligibility'] });
    },
  });
}
3. UI å»ºè­°æ”¾ç½®ä½ç½®
/merchant/dashboard
  â””â”€â”€ è¨‚é–±ç®¡ç†å€å¡Š
       â”œâ”€â”€ ç›®å‰æ–¹æ¡ˆè³‡è¨Š
       â”œâ”€â”€ ä»˜æ¬¾æ­·å²
       â””â”€â”€ ğŸ“Œ è¨‚é–±è¨­å®šï¼ˆæ–°å¢ï¼‰
            â”œâ”€â”€ [å–æ¶ˆè¨‚é–±] æŒ‰éˆ•
            â””â”€â”€ [ç”³è«‹é€€æ¬¾] æŒ‰éˆ•ï¼ˆ7å¤©å…§é¡¯ç¤ºï¼‰
4. é€€æ¬¾ç”³è«‹ UI å…ƒä»¶
// components/RefundRequestDialog.tsx
function RefundRequestDialog({ subscriptionId }: { subscriptionId: number }) {
  const { data: eligibility } = useRefundEligibility(subscriptionId);
  const refundMutation = useRefundRequest();
  const [reason, setReason] = useState('');
  
  if (!eligibility) return null;
  
  return (
    <Dialog>
      <DialogTrigger asChild>
        <Button variant="outline" disabled={!eligibility.refundEligibility.isEligible}>
          ç”³è«‹é€€æ¬¾
        </Button>
      </DialogTrigger>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>ç”³è«‹é€€æ¬¾</DialogTitle>
        </DialogHeader>
        
        {eligibility.refundEligibility.isEligible ? (
          <>
            <p className="text-sm text-green-600">
              âœ“ {eligibility.refundEligibility.reason}
              ï¼ˆå‰©é¤˜ {eligibility.refundEligibility.hoursRemaining} å°æ™‚ï¼‰
            </p>
            <Textarea
              placeholder="è«‹èªªæ˜é€€æ¬¾åŸå› ï¼ˆè‡³å°‘ 10 å­—ï¼‰"
              value={reason}
              onChange={(e) => setReason(e.target.value)}
              minLength={10}
            />
            <Button 
              onClick={() => refundMutation.mutate({ subscriptionId, reason })}
              disabled={reason.length < 10 || refundMutation.isPending}
            >
              {refundMutation.isPending ? 'è™•ç†ä¸­...' : 'ç¢ºèªç”³è«‹é€€æ¬¾'}
            </Button>
          </>
        ) : (
          <p className="text-sm text-slate-500">
            {eligibility.refundEligibility.reason}
          </p>
        )}
      </DialogContent>
    </Dialog>
  );
}
5. cURL æ¸¬è©¦ç¯„ä¾‹
# æª¢æŸ¥é€€æ¬¾è³‡æ ¼
curl -X GET "https://api.mibu-travel.com/api/merchant/subscription/refund-eligibility?subscriptionId=1" \
  -H "Cookie: connect.sid=xxx"
# ç”³è«‹é€€æ¬¾
curl -X POST "https://api.mibu-travel.com/api/merchant/subscription/refund-request" \
  -H "Content-Type: application/json" \
  -H "Cookie: connect.sid=xxx" \
  -d '{"subscriptionId": 1, "reason": "ç”¢å“ä¸ç¬¦åˆéœ€æ±‚ï¼Œå¸Œæœ›ç”³è«‹é€€æ¬¾"}'
